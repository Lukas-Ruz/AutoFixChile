{% extends "base.html" %}
{% load static %}

{% block content %}
    <!-- Mensajes de Django -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Errores generales del form -->
    {% if form.non_field_errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ form.non_field_errors }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}

    <!-- Datos perfil usuario -->
    <div class="container mt-5" style="background-color: white; border-radius: 5px; height: 50rem; max-width: 600px;">
        <h2>Perfil de Usuario</h2>
        <form id="PerfilForm" method="POST" action="{% url 'Perfil' %}" novalidate>
            {% csrf_token %}
            
            <div class="mb-3">
                <label for="nombrePerfil" class="form-label">Nombre</label>
                <input
                    type="text"
                    class="form-control"
                    id="nombrePerfil"
                    name="nombre"
                    value="{{ form.nombre.value|default:user.nombre|default:'' }}"
                    required
                    disabled
                />
                <!-- Errores del campo -->
                {% if form.nombre.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.nombre.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Por favor ingresa tu nombre.</div>
            </div>

            <div class="mb-3">
                <label for="apellidosPerfil" class="form-label">Apellidos</label>
                <input
                    type="text"
                    class="form-control"
                    id="apellidosPerfil"
                    name="apellido"
                    value="{{ form.apellido.value|default:user.apellido|default:'' }}"
                    required
                    disabled
                />
                {% if form.apellido.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.apellido.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Por favor ingresa tus apellidos.</div>
            </div>

            <div class="mb-3">
                <label for="runPerfil" class="form-label">RUN</label>
                <input
                    type="text"
                    class="form-control"
                    id="runPerfil"
                    value="{{ user.run }}"
                    placeholder="00000000-0"
                    required
                    disabled 
                    readonly
                />
                <div class="invalid-feedback">RUN no editable.</div>
            </div>

            <div class="mb-3">
                <label for="fechaNacimientoPerfil" class="form-label">Fecha de Nacimiento</label>
                <input
                    type="date"
                    class="form-control"
                    id="fechaNacimientoPerfil"
                    name="fecha_nacimiento"
                    value="{{ form.fecha_nacimiento.value|date:'Y-m-d'|default:'' }}" 
                    required
                    disabled
                />
                {% if form.fecha_nacimiento.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.fecha_nacimiento.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Por favor ingresa tu fecha de nacimiento.</div>
            </div>

            <div class="mb-3">
                <label for="telefonoPerfil" class="form-label">Teléfono</label>
                <input
                    type="tel"
                    class="form-control"
                    id="telefonoPerfil"
                    name="telefono"
                    value="{{ form.telefono.value|default:user.telefono|default:'' }}"
                    required
                    disabled
                />
                {% if form.telefono.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.telefono.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Por favor ingresa tu teléfono.</div>
            </div>

            <div class="mb-3">
                <label for="direccionPerfil" class="form-label">Dirección</label>
                <input
                    type="text"
                    class="form-control"
                    id="direccionPerfil"
                    name="direccion"
                    value="{{ form.direccion.value|default:user.direccion|default:'' }}"
                    required
                    disabled
                />
                {% if form.direccion.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.direccion.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Por favor ingresa tu dirección.</div>
            </div>

            <div class="mb-3">
                <button type="button" id="btnEditar" class="btn btn-primary">Editar</button>
            </div>
            <button type="submit" class="btn btn-success" id="btnGuardar" disabled>Guardar Cambios</button>
        </form>
    </div>
{% endblock content %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% block extraScript %}
    <script>
        $(document).ready(function () {

            function setEdicion(estado) {
                $("#nombrePerfil, #apellidosPerfil, #fechaNacimientoPerfil, #telefonoPerfil, #direccionPerfil").prop("disabled", !estado);
                $("#btnGuardar").prop("disabled", !estado);
                $("#runPerfil").prop("disabled", true);
            }

            setEdicion(false);


            $("#btnEditar").click(function () {
                if ($(this).text() === "Editar") {

                    setEdicion(true);
                    $(this).text("Cancelar");
                } else {

                    location.reload();

                }
            });


            $("#PerfilForm").on("submit", function (e) {
                let valido = true;

                $("#PerfilForm input").removeClass("is-invalid");

                if (!$("#nombrePerfil").val().trim()) {
                    $("#nombrePerfil").addClass("is-invalid");
                    valido = false;
                }
                if (!$("#apellidosPerfil").val().trim()) {
                    $("#apellidosPerfil").addClass("is-invalid");
                    valido = false;
                }

                if (!$("#fechaNacimientoPerfil").val()) {
                    $("#fechaNacimientoPerfil").addClass("is-invalid");
                    valido = false;
                }

                if (!$("#telefonoPerfil").val().trim()) {
                    $("#telefonoPerfil").addClass("is-invalid");
                    valido = false;
                }
                const telVal = $("#telefonoPerfil").val().trim();
                if (telVal && !telVal.startsWith('+56')) {
                    $("#telefonoPerfil").addClass("is-invalid");
                    valido = false;
                }

                if (!$("#direccionPerfil").val().trim()) {
                    $("#direccionPerfil").addClass("is-invalid");
                    valido = false;
                }

                if (!valido) {
                    e.preventDefault();  // Bloquea submit si JS falla
                    return false;
                }
            });
        });
    </script>
{% endblock extraScript %}