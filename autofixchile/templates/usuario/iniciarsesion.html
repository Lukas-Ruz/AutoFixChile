{% extends "base.html" %}
{% load static %}
{% load socialaccount %}

{% block content %}
    <!-- Formulario -->
    <div class="container mt-5" style="background-color: white; border-radius: 5px; height: 50rem; max-width: 600px;">
        <h2 style="text-align: center">Inicio de Sesión</h2>

        <!-- Mensajes de Django -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Errores generales del form -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                {{ form.non_field_errors }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endif %}

        <form id="loginForm" method="POST" action="{% url 'Login' %}" novalidate>
            {% csrf_token %}
            
            <div class="mb-3">
                <label for="username" class="form-label">RUN</label>
                <input
                    type="text"
                    class="form-control"
                    id="username"
                    name="username"
                    placeholder="12345678-9"
                    required
                />
                <!-- Errores del campo username (ej. "RUN inválido") -->
                {% if form.username.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.username.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Formato RUN inválido (12345678-9)</div>
            </div>

            <div class="mb-3">
                <label for="password" class="form-label">Contraseña</label>
                <input
                    type="password"
                    class="form-control"
                    id="password"
                    name="password"
                    required
                />
                {% if form.password.errors %}
                    <div class="invalid-feedback d-block">
                        {{ form.password.errors }}
                    </div>
                {% endif %}
                <div class="invalid-feedback">Por favor ingresa tu contraseña.</div>
            </div>
                <div style="text-align: center; margin-top: 20px;">

        <p>O inicia sesión con:</p>
        <a href="{% provider_login_url 'google'
        process='connect'%}" class="btn btn-secondary">
            <img src="{% static 'img/googlelogo.png' %}" alt="Google" style="height: 20px; margin-right: 10px;">
            Iniciar sesión con Google
        </a>
    </div>

            <button type="submit" class="btn btn-primary">Ingresar</button>
            <a href="{% url 'Recuperar' %}">Recuperar contraseña</a>
        </form>
    </div>
{% endblock content %}

{% block extraScript %}
    <script>
        $(document).ready(function () {
            $("#loginForm").on("submit", function (e) {
                e.preventDefault();

                // Limpiar estados previos
                $("input").removeClass("is-invalid");

                let valido = true;

                // Validar RUN 
                const runVal = $("#username").val().trim();  <!-- Cambiado de #run -->
                const runRegex = /^\d{7,8}-[0-9kK]$/;
                if (!runRegex.test(runVal)) {
                    $("#username").addClass("is-invalid");  <!-- Cambiado -->
                    valido = false;
                }

                // Validar contraseña (igual)
                if (!$("#password").val()) {
                    $("#password").addClass("is-invalid");
                    valido = false;
                }

                if (valido) {
                    this.submit(); 
                }
            });
        });
    </script>
{% endblock %}
